---
date: "2016-12-01T16:00:00+02:00"
title: "Аутентификация"
slug: "authentication"
weight: 10
toc: true
draft: false
menu:
  sidebar:
    parent: "features"
    name: "Аутентификация"
    weight: 10
    identifier: "authentication"
---

# Аутентификация

## LDAP (Lightweight Directory Access Protocol)

И LDAP через BindDN, и простой аутентификационный LDAP используют следующие поля:

- Имя авторизации **(обязательный)**
  - Имя для входа новому методу авторизации.

- Хост **(обязательный)**
  - Адрес, по которому можно связаться с сервером LDAP.
  - Например: `mydomain.com`

- Порт **(обязательный)**
  - Порт, используемый при подключении к серверу.
  - Например: `389` для LDAP или `636` для LDAP SSL

- Включить шифрование TLS (необязательно)
  - Следует ли использовать TLS при подключении к серверу LDAP.

- Фильтр администратора (необязательно)
  - Фильтр LDAP, определяющий, следует ли предоставлять
    пользователю права администратора. Если учётная запись
    пользователя проходит фильтр, пользователь получает права
	администратора.
  - Например: `(objectClass=adminAccount)`
  - Пример для Microsoft Active Directory (AD): `(memberOf=CN=admin-group,OU=example,DC=example,DC=org)`

- Атрибут имени пользователя (необязательно)
  - Атрибут записи LDAP пользователя, содержащий имя пользователя. 
    Данное значение атрибута будет использоваться для нового имени 
	пользователя учётной записи Gitea после первого успешного входа 
	в систему. Оставьте поле пустым, чтобы использовать имя для входа, 
	указанное в форме входа.
  - Это полезно, когда предоставленное имя входа сопоставляется с
    несколькими атрибутами, но для имени учётной записи Gitea следует 
	использовать только один конкретный атрибут, см. 'Фильтр пользователей'.
  - Например: `uid`
  - Пример для Microsoft Active Directory (AD): `sAMAccountName`

- Атрибут имени (необязательно)
  - Атрибут записи LDAP пользователя, содержащий имя пользователя. 
    Это будет использоваться для заполнения информации об учётной записи.
  - Например: `givenName`

- Атрибут фамилии (необязательно)
  - Атрибут записи LDAP пользователя, содержащий фамилию пользователя. 
    Это будет использоваться для заполнения информации об учётной записи.
  - Например: `sn`

- Атрибут эл. почты **(обязательный)**
  - Атрибут записи LDAP пользователя, содержащий адрес электронной почты 
    пользователя. Это будет использоваться для заполнения информации об учётной записи.
  - Например: `mail`

**LDAP через BindDN** добавляет следующие поля:

- Привязка DN (необязательно)
  - DN для привязки к серверу LDAP при поиске пользователя. Это поле можно оставить пустым, 
    чтобы выполнить анонимный поиск.
  - Например: `cn=Search,dc=mydomain,dc=com`

- Привязка пароля (необязательно)
  - Пароль для указанной выше Привязки DN, если таковой имеется. _Примечание: пароль 
    хранится на сервере в виде открытого текста. Таким образом, убедитесь, что Bind DN
	имеет как можно меньше привилегий._

- База поиска пользователей **(обязательный)**
  - База LDAP, по которой будут выполняться поиск учётных записей пользователей.
  - Например: `ou=Users,dc=mydomain,dc=com`

- Фильтр пользователей **(обязательный)**
  - Фильтр LDAP, объявляющий, как найти запись пользователя, которая пытается
    аутентифицироваться. Параметр соответствия `%s` будет заменен именем входа,
	указанным в форме входа.
  - Например: `(&(objectClass=posixAccount)(uid=%s))`
  - Пример для Microsoft Active Directory (AD): `(&(objectCategory=Person)(memberOf=CN=user-group,OU=example,DC=example,DC=org)(sAMAccountName=%s)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))`
  - Чтобы заменить более одного раза, следует использовать `%[1]s`, например
    при сопоставлении предоставленного имени входа с несколькими атрибутами, такими как
	идентификатор пользователя, адрес электронной почты или даже номер телефона.
  - Например: `(&(objectClass=Person)(|(uid=%[1]s)(mail=%[1]s)(mobile=%[1]s)))`
- Включить синхронизацию пользователей
  - Эта опция включает периодическую задачу, которая синхронизирует пользователей Gitea
    с сервером LDAP. Период по умолчанию - каждые 24 часа, но его можно изменить в файле
	app.ini. См. Раздел *cron.sync_external_users* в
    [образце
    app.ini](https://github.com/go-gitea/gitea/blob/master/custom/conf/app.example.ini)
    для подробных комментариев по этому разделу. Обратитесь к *База поиска пользователей*
	и *Фильтр пользователей*, описанные выше, ограничивают, какие пользователи могут
	использовать Gitea и какие пользователи будут синхронизированы. При первоначальном
	запуске задача создаст всех пользователей LDAP, которые соответствуют заданным
	параметрам, поэтому будьте осторожны при работе с большими каталогами Enterprise LDAP.

**LDAP используя простую аутентификацию** добавляет следующие поля:

- DN пользователя **(обязательный)**
  - Шаблон для использования в качестве DN пользователя.
    Параметр соответствия `%s` будет заменён именем входа,
	указанным в форме входа.
  - Например: `cn=%s,ou=Users,dc=mydomain,dc=com`
  - Например: `uid=%s,ou=Users,dc=mydomain,dc=com`

- База поиска пользователей (необязательно)
  - База LDAP, в которой будет выполняться поиск учётных записей пользователей.
  - Например: `ou=Users,dc=mydomain,dc=com`

- User Filter **(обязательный)**
  - Фильтр LDAP, объявляющий, когда пользователю следует разрешить вход в систему. 
    Параметр соответствия `%s` будет заменён именем входа, указанным в форме входа.
  - Например: `(&(objectClass=posixAccount)(cn=%s))`
  - Например: `(&(objectClass=posixAccount)(uid=%s))`

**Подтверждение членства в группе LDAP** использует следующие поля:

* База поиска группы (необязательно)
    * DN LDAP, используемый для групп.
    * Например: `ou=group,dc=mydomain,dc=com`

* Фильтр имени группы (необязательно)
    * Фильтр LDAP, объявляющий, как найти допустимые группы в указанном выше DN.
    * Например: `(|(cn=gitea_users)(cn=admins))`

* Атрибут пользователя в группе (необязательно)
    * Какой пользовательский атрибут LDAP указан в группе.
    * Например: `uid`

* Атрибут группы для пользователя (необязательно)
    * Атрибут LDAP какой группы содержит массив над именами пользовательских атрибутов.
    * Например: `memberUid`

## PAM (Pluggable Authentication Module)

Чтобы настроить PAM, установите 'PAM Service Name' равным имени файла в
'/etc/pam.d/'. Для работы с обычными паролями Linux пользователь,
работающий с Gitea, должен иметь доступ для чтения к `/etc/shadow`.

## SMTP (Simple Mail Transfer Protocol)

Эта опция позволяет Gitea входить на SMTP-хост в качестве пользователя Gitea.
Чтобы настроить это, установите поля ниже:

- Имя аутентификации **(обязательный)**
  - Имя для входа нового метода авторизации.

- Тип аутентификации SMTP **(обязательный)**
  - Тип аутентификации, используемый для подключения к SMTP-хосту, PLAIN или LOGIN.

- Хост **(обязательный)**
  - Адрес, по которому можно связаться с SMTP-хостом.
  - Например: `smtp.mydomain.com`

- Порт **(обязательный)**
  - Порт, используемый при подключении к серверу.
  - Например: `587`

- Разрешённые домены
  - Ограничьте, какие домены могут входить в систему при использовании
   общедоступного хоста SMTP или хоста SMTP с несколькими доменами.
  - Например: `gitea.io,mydomain.com,mydomain2.com`

- Включить шифрование TLS
  - Включите шифрование TLS при аутентификации.

- Пропустить проверку TLS
  - Отключите проверку TLS при аутентификации.

- Эта аутентификация активирована
  - Включить или отключить эту аутентификацию.

## FreeIPA

- Чтобы войти в Gitea с учётными данными FreeIPA, 
  необходимо создать привязанную учётную запись для Gitea:

- На сервере FreeIPA создайте файл `gitea.ldif`, заменив `dc=example,dc=com`
  на свой DN, и укажите надёжный пароль:
```
  dn: uid=gitea,cn=sysaccounts,cn=etc,dc=example,dc=com
  changetype: add
  objectclass: account
  objectclass: simplesecurityobject
  uid: gitea
  userPassword: secure password
  passwordExpirationTime: 20380119031407Z
  nsIdleTimeout: 0
```

- Импортируйте LDIF (при необходимости измените localhost на IPA-сервер). 
  Будет представлен запрос пароля диспетчера каталогов:
```
  ldapmodify -h localhost -p 389 -x -D \
  "cn=Directory Manager" -W -f gitea.ldif
```
- Добавьте группу IPA для gitea\_users :
```
  ipa group-add --desc="Gitea Users" gitea_users
```
- Примечание: В случае ошибок, связанных с учётными данными IPA, запустите `kinit admin`
  и укажите пароль учётной записи администратора домена.

- Войдите в Gitea как администратор и нажмите "Аутентификация" в панели администратора.
  Затем нажмите `Add New Source` и введите данные, при необходимости изменив все.

## SPNEGO с SSPI (Kerberos / NTLM, только для Windows)

Gitea поддерживает аутентификацию единого входа SPNEGO (схема, определённая RFC4559) для веб-части сервера через интерфейс поставщика поддержки безопасности (SSPI), встроенный в Windows. SSPI работает только в средах Windows - когда и сервер, и клиенты работают под Windows.

Перед активацией SSPI проверки подлинности единого входа (SSO) необходимо подготовить среду:

- Создайте отдельную учётную запись пользователя в активном каталоге, под которой будет запускаться процесс `gitea.exe` (например,`user` в домене `domain.local`):

- Создайте имя участника службы для хоста, на котором выполняется `gitea.exe` с классом `HTTP`:
  - Запустите `Command Prompt` или `PowerShell` как привилегированный пользователь домена (как администратор домена)
  - Выполните приведенную ниже команду, заменив `host.domain.local` на полное доменное имя (FQDN) сервера, на котором будет работать веб-приложение, а `domain\user` на имя учётной записи, созданной на предыдущем шаге:
  ```
    setspn -A HTTP/host.domain.local domain\user
  ```

- Войдите в систему (*выйдите из системы, если вы уже вошли в систему*) с созданным пользователем

- Убедитесь, что `ROOT_URL` в разделе `[server]` файла `custom/conf/app.ini` - это полное доменное имя сервера, на котором будет работать веб-приложение - то же самое, что вы использовали при создании субъекта-службы. имя (например, `host.domain.local`)

- Запустите веб-сервер (`gitea.exe web`)

- Включите аутентификацию SSPI, добавив источник аутентификации `SPNEGO with SSPI` в `Site Administration -> Authentication Sources`

- Войдите на клиентский компьютер в том же домене с любым пользователем домена (клиентский компьютер, отличный от сервера, на котором запущен `gitea.exe`)

- Если вы используете Chrome или Edge, добавьте URL-адрес веб-приложения на сайты локальной интрасети (`Свойства браузера -> Безопасность -> Локальная интрасеть -> Сайты`)

- Запустите Chrome или Edge и перейдите к URL-адресу FQDN gitea (например, `http://host.domain.local:3000`)

- Нажмите кнопку `Войти` на панели управления и выберите SSPI для автоматического входа в систему с тем же пользователем, который в настоящее время вошёл в систему на компьютере.

- Если не работает, убедитесь, что:
  - Вы не используете веб-браузер на том же сервере, где работает gitea. Вы должны запустить веб-браузер на подключённом к домену компьютере (клиенте), который отличается от сервера. Если и клиент, и сервер работают на одном компьютере, NTLM будет предпочтительнее Kerberos.
  - Для хоста существует только одно имя участника-службы `HTTP/...`
  - SPN содержит только имя хоста без порта
  - Вы добавили URL-адрес веб-приложения в зону `Местная интрасеть`
  - Часы сервера и клиента не должны отличаться более чем на 5 минут (зависит от групповой политики)
  - В Internet Explorer должна быть включена функция `Встроенная проверка подлинности Windows` (в разделе `Дополнительные настройки`)
