---
date: "2020-01-16"
title: "Подготовка базы данных"
slug: "database-prep"
weight: 10
toc: true
draft: false
menu:
  sidebar:
    parent: "installation"
    name: "Подготовка базы данных"
    weight: 20
    identifier: "database-prep"
---

Для использования Gitea вам нужна база данных. Gitea поддерживает PostgreSQL, MySQL, SQLite и MSSQL. Эта страница поможет вам подготовить базу данных. Здесь будут рассмотрены только PostgreSQL и MySQL, поскольку эти механизмы баз данных широко используются в производстве.

Экземпляр базы данных может находиться на том же компьютере, что и Gitea (настройка локальной базы данных), или на другом компьютере (удаленная база данных).

Примечание. Для выполнения всех шагов ниже требуется, чтобы в вашей системе был установлен выбранный вами механизм базы данных. Для удаленной настройки базы данных установите серверную часть на экземпляр базы данных и клиентскую часть на вашем сервере Gitea. Кроме того, убедитесь, что вы используете одну и ту же версию движка для сервера и клиента, чтобы некоторые функции движка работали. В целях безопасности защитите суперпользователя базы данных `root` (MySQL) или `postgres` (PostgreSQL) надёжным паролем. Предполагается, что вы используете Linux как для серверов баз данных, так и для серверов Gitea.

## MySQL

1.  В экземпляре базы данных войдите в консоль базы данных как root:

    ```
    mysql -u root -p
    ```

    Введите пароль по запросу.

2.  Создайте пользователя базы данных, который будет использоваться Gitea, аутентифицированный паролем. В этом примере в качестве пароля используется `'gitea'`. Пожалуйста, используйте безопасный пароль для вашего экземпляра. 

    Для локальной базы данных:

    ```sql
    SET old_passwords=0;
    CREATE USER 'gitea' IDENTIFIED BY 'gitea';
    ```

    Для удалённой базы данных:

    ```sql
    SET old_passwords=0;
    CREATE USER 'gitea'@'192.0.2.10' IDENTIFIED BY 'gitea';
    ```

    где `192.0.2.10` - это IP-адрес вашего экземпляра Gitea.

    При необходимости замените имя пользователя и пароль, указанные выше.

3.  Создайте базу данных с кодировкой UTF-8 и сопоставлением. Обязательно используйте кодировку `utf8mb4` вместо `utf8`, поскольку первая поддерживает все символы Unicode (включая смайлы) за пределами *Basic Multilingual Plane*. Кроме того, сортировка выбирается в зависимости от вашего ожидаемого контента. В случае сомнений используйте `unicode_ci` или `general_ci`.

    ```sql
    CREATE DATABASE giteadb CHARACTER SET 'utf8mb4' COLLATE 'utf8mb4_unicode_ci';
    ```

    Замените имя базы данных соответствующим образом.

4.  Предоставьте все права доступа к базе данных пользователю базы данных, созданному выше.

    Для локальной базы данных:

    ```sql
    GRANT ALL PRIVILEGES ON giteadb.* TO 'gitea';
    FLUSH PRIVILEGES;
    ```

    Для удалённой базы данных:

    ```sql
    GRANT ALL PRIVILEGES ON giteadb.* TO 'gitea'@'192.0.2.10';
    FLUSH PRIVILEGES;
    ```

5.  Выйти из консоли базы данных с помощью `exit`.

6.  На вашем сервере Gitea проверьте подключение к базе данных:

    ```
    mysql -u gitea -h 203.0.113.3 -p giteadb
    ```

    где `gitea` - имя пользователя базы данных, `giteadb` - имя базы данных, а `203.0.113.3` - IP-адрес экземпляра базы данных. Опустите параметр `-h` для локальной базы данных.

    Вы должны быть подключены к базе данных.

## PostgreSQL

1.  PostgreSQL по умолчанию использует схему шифрования запрос-ответ `md5` для аутентификации по паролю. В настоящее время эта схема уже не считается безопасной. Вместо этого используйте схему SCRAM-SHA-256, отредактировав файл конфигурации `postgresql.conf` на сервере базы данных, чтобы:

    ```ini
    password_encryption = scram-sha-256
    ```

    Перезапустите PostgreSQL, чтобы применить настройку.

2.  На сервере базы данных войдите в консоль базы данных как суперпользователь.:

    ```
    su -c "psql" - postgres
    ```

3.  Создайте пользователя базы данных (роль в терминах PostgreSQL) с правами входа и паролем. Пожалуйста, используйте надежный и надежный пароль вместо `'gitea'` ниже:

    ```sql
    CREATE ROLE gitea WITH LOGIN PASSWORD 'gitea';
    ```

    При необходимости замените имя пользователя и пароль.

4.  Создайте базу данных с кодировкой UTF-8, принадлежащую пользователю базы данных, созданному ранее. Любые сопоставления `libc` могут быть указаны с параметрами `LC_COLLATE` и `LC_CTYPE`, в зависимости от ожидаемого содержимого.:

    ```sql
    CREATE DATABASE giteadb WITH OWNER gitea TEMPLATE template0 ENCODING UTF8 LC_COLLATE 'en_US.UTF-8' LC_CTYPE 'en_US.UTF-8';
    ```

    Замените имя базы данных соответствующим образом.

5.  Разрешите пользователю базы данных получить доступ к базе данных, созданной выше, добавив следующее правило аутентификации в `pg_hba.conf`.

    Для локальной базы данных:

    ```ini
    local    giteadb    gitea    scram-sha-256
    ```

    Для удалённой базы данных:

    ```ini
    host    giteadb    gitea    192.0.2.10/32    scram-sha-256
    ```

    Замените имя базы данных, пользователя и IP-адрес экземпляра Gitea своими собственными.

    Примечание: правила в `pg_hba.conf` оцениваются последовательно, то есть первое подходящее правило будет использоваться для аутентификации. Ваша установка PostgreSQL может иметь общие правила аутентификации, которые подходят для всех пользователей и баз данных. Возможно, вам придется разместить правила, представленные здесь, над такими общими правилами, если это так.

    Перезапустите PostgreSQL, чтобы применить новые правила аутентификации.
    
6.  На вашем сервере Gitea проверьте подключение к базе данных.

    Для локальной базы данных:

    ```
    psql -U gitea -d giteadb
    ```

    Для удалённой базы данных:

    ```
    psql "postgres://gitea@203.0.113.3/giteadb"
    ```

    где `gitea` - пользователь базы данных, giteadb - имя базы данных, а `203.0.113.3` - IP-адрес вашего экземпляра базы данных.

    Вам будет предложено ввести пароль для пользователя базы данных и подключиться к базе данных.

## Подключение к базе данных через TLS

Если связь между Gitea и вашим экземпляром базы данных осуществляется через частную сеть или если Gitea и база данных работают на одном сервере, этот раздел можно пропустить, поскольку безопасность между Gitea и экземпляром базы данных критически не подвергается. Если вместо этого экземпляр базы данных находится в общедоступной сети, используйте TLS для шифрования соединения с базой данных, поскольку третьи стороны могут перехватить данные трафика.

### Предпосылки

- Вам понадобятся два действительных сертификата TLS: один для экземпляра базы данных (сервер базы данных) и один для экземпляра Gitea (клиент базы данных). Оба сертификата должны быть подписаны доверенным центром сертификации.
- Сертификат базы данных должен содержать `TLS Web Server Authentication` в атрибуте расширения `X509v3 Extended Key Usage`, а для сертификата клиента требуется `TLS Web Client Authentication` в соответствующем атрибуте.
- В сертификате сервера базы данных одна из записей `Альтернативное имя субъекта` или `Общее имя` должно быть полным доменным именем (FQDN) экземпляра базы данных (например, `db.example.com`). В сертификате клиента базы данных одна из упомянутых выше записей должна содержать имя пользователя базы данных, которое Gitea будет использовать для подключения.
- Вам необходимо сопоставить доменные имена серверов Gitea и баз данных с соответствующими IP-адресами. Либо настройте для них записи DNS, либо добавьте локальные сопоставления в `/etc/hosts` (`%WINDIR%\System32\drivers\etc\hosts` в Windows) в каждой системе. Это позволяет подключаться к базе данных по доменному имени, а не по IP-адресу. См. Подробную информацию в документации вашей системы.

### PostgreSQL

Драйвер PostgreSQL, используемый Gitea, поддерживает двусторонний TLS. В двустороннем TLS и клиент базы данных, и сервер аутентифицируют друг друга, отправляя свои соответствующие сертификаты на свою противоположную сторону для проверки. Другими словами, сервер проверяет сертификат клиента, а клиент проверяет сертификат сервера.

1.  На сервере с экземпляром базы данных разместите следующие учётные данные:

    -  `/path/to/postgresql.crt`: Сертификат экземпляра базы данных
    -  `/path/to/postgresql.key`: Закрытый ключ экземпляра базы данных
    -  `/path/to/root.crt`: Цепочка сертификатов CA для проверки сертификатов клиентов

2.  Добавьте следующие параметры в `postgresql.conf`:

    ```ini
    ssl = on
    ssl_ca_file = '/path/to/root.crt'
    ssl_cert_file = '/path/to/postgresql.crt'
    ssl_key_file = '/path/to/postgresql.key'
    ssl_min_protocol_version = 'TLSv1.2'
    ```

3.  Настройте право собственности на учётные данные и разрешения, как того требует PostgreSQL:

    ```
    chown postgres:postgres /path/to/root.crt /path/to/postgresql.crt /path/to/postgresql.key
    chmod 0600 /path/to/root.crt /path/to/postgresql.crt /path/to/postgresql.key
    ```

4.  Измените правило `pg_hba.conf`, чтобы разрешить пользователю базы данных Gitea подключаться только через SSL и потребовать проверки сертификата клиента.

    Для PostgreSQL 12:

    ```ini
    hostssl    giteadb    gitea    192.0.2.10/32    scram-sha-256    clientcert=verify-full
    ```

    Для PostgreSQL 11 и ранее:

    ```ini
    hostssl    giteadb    gitea    192.0.2.10/32    scram-sha-256    clientcert=1
    ```

    Замените имя базы данных, пользователя и IP-адрес экземпляра Gitea соответствующим образом.

5.  Перезапустите PostgreSQL, чтобы применить указанные выше конфигурации.

6.  На сервере, на котором запущен экземпляр Gitea, поместите следующие учетные данные в домашний каталог пользователя, который запускает Gitea (например, `git`):

    -  `~/.postgresql/postgresql.crt`: Сертификат клиента базы данных
    -  `~/.postgresql/postgresql.key`: Закрытый ключ клиента базы данных
    -  `~/.postgresql/root.crt`: Цепочка сертификатов CA для проверки сертификата сервера

    Примечание. Указанные выше имена файлов жёстко запрограммированы в PostgreSQL, и изменить их невозможно.

7.  При необходимости измените учётные данные, право собственности и разрешения:

    ```
    chown git:git ~/.postgresql/postgresql.crt ~/.postgresql/postgresql.key ~/.postgresql/root.crt
    chown 0600 ~/.postgresql/postgresql.crt ~/.postgresql/postgresql.key ~/.postgresql/root.crt
    ```

8.  Проверить подключение к базе данных:

    ```
    psql "postgres://gitea@example.db/giteadb?sslmode=verify-full"
    ```

    Вам будет предложено ввести пароль для пользователя базы данных, а затем вы подключитесь к базе данных.


### MySQL

Хотя драйвер MySQL, используемый Gitea, также поддерживает двусторонний TLS, Gitea в настоящее время поддерживает только односторонний TLS. Подробности смотрите в выпуске #10828.

В одностороннем TLS клиент базы данных проверяет сертификат, отправленный с сервера во время подтверждения соединения, и сервер предполагает, что подключенный клиент является легитимным, поскольку проверка сертификата клиента не выполняется.


1.  В экземпляре базы данных поместите следующие учётные данные:

    -  `/path/to/mysql.crt`: Сертификат экземпляра базы данных
    -  `/path/to/mysql.key`: Ключ экземпляра базы данных
    -  `/path/to/ca.crt`: Цепочка сертификатов CA. Этот файл не используется в одностороннем TLS, но используется для проверки клиентских сертификатов в двустороннем TLS.

2.  Добавьте следующие параметры в `my.cnf`:

    ```ini
    [mysqld]
    ssl-ca = /path/to/ca.crt
    ssl-cert = /path/to/mysql.crt
    ssl-key = /path/to/mysql.key
    tls-version = TLSv1.2,TLSv1.3
    ```

3.  Настройте право собственности на учётные данные и разрешения:

    ```
    chown mysql:mysql /path/to/ca.crt /path/to/mysql.crt /path/to/mysql.key
    chmod 0600 /path/to/ca.crt /path/to/mysql.crt /path/to/mysql.key
    ```

4.  Перезапустите MySQL, чтобы применить настройку.

5.  Пользователь базы данных для Gitea мог быть создан ранее, но он будет аутентифицироваться только по IP-адресам сервера, на котором запущен Gitea. Чтобы аутентифицироваться по его доменному имени, воссоздайте пользователя и на этот раз также установите для него требование TLS для подключения к базе данных:

    ```sql
    DROP USER 'gitea'@'192.0.2.10';
    CREATE USER 'gitea'@'example.gitea' IDENTIFIED BY 'gitea' REQUIRE SSL;
    GRANT ALL PRIVILEGES ON giteadb.* TO 'gitea'@'example.gitea';
    FLUSH PRIVILEGES;
    ```

    Замените имя пользователя базы данных, пароль и домен экземпляра Gitea соответствующим образом.

6.  Убедитесь, что цепочка сертификатов CA, необходимая для проверки сертификата сервера базы данных, находится в системном хранилище сертификатов как базы данных, так и серверов Gitea. Инструкции по добавлению сертификата CA в хранилище сертификатов см. В документации к вашей системе.

7.  На сервере под управлением Gitea проверьте подключение к базе данных:

    ```
    mysql -u gitea -h example.db -p --ssl
    ```

    Вы должны быть подключены к базе данных.
